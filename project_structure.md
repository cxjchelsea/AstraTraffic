# AstraTraffic é¡¹ç›®ç›®å½•ç»“æ„

åŸºäº LangChain æ¶æ„çš„æ™ºæ…§äº¤é€š RAG ç³»ç»Ÿ

---

## ğŸ“ æ ¹ç›®å½•æ–‡ä»¶

```
â”œâ”€â”€ rag_types.py              # é€šç”¨æ•°æ®ç±»å‹å®šä¹‰ï¼ˆAnswerPack, IntentResult, Hit, Metrics ç­‰ï¼‰
â”œâ”€â”€ settings.py               # å…¨å±€é…ç½®æ–‡ä»¶ï¼ˆæ¨¡å‹è·¯å¾„ã€APIå¯†é’¥ã€æ£€ç´¢å‚æ•°ç­‰ï¼‰
â”œâ”€â”€ requirements.txt          # Python ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ test.py                   # æµ‹è¯•è„šæœ¬
â””â”€â”€ é¡¹ç›®ç›®å½•.md               # æœ¬æ–‡ä»¶ï¼šé¡¹ç›®ç»“æ„è¯´æ˜
```

---

## ğŸ§± lc/ - LangChain é€‚é…å±‚

LangChain æ¡†æ¶é€‚é…å±‚ï¼Œè´Ÿè´£å°†åº•å±‚æ¨¡å—é€‚é…ä¸º LangChain æ¥å£

```
lc/
â”œâ”€â”€ __init__.py               # åŒ…åˆå§‹åŒ–æ–‡ä»¶
â”œâ”€â”€ rag_chain.py              # RAG æ ¸å¿ƒé“¾ï¼ˆä½¿ç”¨ LCEL ç¼–æ’æ„å›¾è¯†åˆ« â†’ æ£€ç´¢ â†’ LLM ç”Ÿæˆï¼‰
â”œâ”€â”€ intent_adapter.py         # æ„å›¾è¯†åˆ«é€‚é…å™¨ï¼ˆç»Ÿä¸€è§„åˆ™å’Œæ¨¡å‹ä¸¤ç§æ–¹å¼ï¼‰
â”œâ”€â”€ retriever_adapter.py      # æ£€ç´¢é€‚é…å™¨ï¼ˆå°è£… FAISS + BM25 + é‡æ’åºï¼‰
â”œâ”€â”€ llm_adapter.py            # LLM é€‚é…å™¨ï¼ˆæ”¯æŒ OpenAIã€Ollamaã€è‡ªå®šä¹‰ HTTPï¼‰
â””â”€â”€ prompt_adapter.py         # Prompt é€‚é…å™¨ï¼ˆå°†åº•å±‚ prompt é€‚é…ä¸º LangChain PromptTemplateï¼‰
```

---

## ğŸ”§ modules/ - åº•å±‚æ ¸å¿ƒå®ç°

æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼Œä¸ä¾èµ–ç‰¹å®šæ¡†æ¶ï¼Œå¯ç‹¬ç«‹ä½¿ç”¨

### modules/generator/ - ç”Ÿæˆå™¨æ¨¡å—

```
modules/generator/
â””â”€â”€ prompt.py                 # Prompt æ¨¡æ¿åº•å±‚å®ç°ï¼ˆä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ– LangChainï¼‰
                              # - RAG_PROMPT_TEMPLATE: æç¤ºè¯æ¨¡æ¿æ–‡æœ¬
                              # - format_hits_to_context(): æ ¼å¼åŒ–æ£€ç´¢ç»“æœ
                              # - build_prompt(): æ„å»ºå®Œæ•´ prompt
```

### modules/intent/ - æ„å›¾è¯†åˆ«æ¨¡å—

```
modules/intent/
â”œâ”€â”€ intent_classify.py        # æ„å›¾åˆ†ç±»æ ¸å¿ƒå®ç°ï¼ˆBERT + LoRA æ¨ç†ï¼‰
â”‚                             # - load_intent_model(): åŠ è½½æ„å›¾æ¨¡å‹
â”‚                             # - predict_intent(): é¢„æµ‹æ„å›¾ï¼ˆæ”¯æŒå¤šä»»åŠ¡å’Œå•ä»»åŠ¡ï¼‰
â”‚
â””â”€â”€ model_training/           # æ„å›¾æ¨¡å‹è®­ç»ƒç›¸å…³
    â”œâ”€â”€ train/                # è®­ç»ƒè„šæœ¬
    â”‚   â”œâ”€â”€ train_intent_lora.py          # å•ä»»åŠ¡æ„å›¾æ¨¡å‹è®­ç»ƒ
    â”‚   â”œâ”€â”€ train_intent_lora_multitask.py # å¤šä»»åŠ¡æ„å›¾æ¨¡å‹è®­ç»ƒ
    â”‚   â”œâ”€â”€ infer_intent_lora.py          # å•ä»»åŠ¡æ¨ç†è„šæœ¬
    â”‚   â”œâ”€â”€ infer_intent_lora_multitask.py # å¤šä»»åŠ¡æ¨ç†è„šæœ¬
    â”‚   â”œâ”€â”€ intent_classify.py            # æ„å›¾åˆ†ç±»å·¥å…·å‡½æ•°
    â”‚   â”œâ”€â”€ intent_classify_multitask.py  # å¤šä»»åŠ¡æ„å›¾åˆ†ç±»å·¥å…·
    â”‚   â”œâ”€â”€ load_bert.py                  # BERT æ¨¡å‹åŠ è½½å·¥å…·
    â”‚   â””â”€â”€ loraå¾®è°ƒBERTæµç¨‹.md           # LoRA å¾®è°ƒæµç¨‹æ–‡æ¡£
    â”‚
    â”œâ”€â”€ data/                 # è®­ç»ƒæ•°æ®å¤„ç†
    â”‚   â”œâ”€â”€ intent/                       # æ„å›¾è¯†åˆ«æ•°æ®é›†ï¼ˆtrain/dev/testï¼‰
    â”‚   â”œâ”€â”€ label_data/                   # åŸå§‹æ ‡æ³¨æ•°æ®
    â”‚   â”œâ”€â”€ augment.py                    # æ•°æ®å¢å¼ºè„šæœ¬
    â”‚   â”œâ”€â”€ split.py                      # æ•°æ®é›†åˆ‡åˆ†è„šæœ¬
    â”‚   â””â”€â”€ merge_ls_export.py           # æ ‡ç­¾ç³»ç»Ÿå¯¼å‡ºåˆå¹¶è„šæœ¬
    â”‚
    â””â”€â”€ models/               # è®­ç»ƒå¥½çš„æ¨¡å‹ï¼ˆæœ¬åœ°ï¼‰
        â”œâ”€â”€ bert-base-chinese/            # åŸºç¡€ BERT æ¨¡å‹
        â””â”€â”€ bert-intent-lora-v1/          # LoRA å¾®è°ƒåçš„æ„å›¾æ¨¡å‹
            â”œâ”€â”€ ds_single/                # å•ä»»åŠ¡æ¨¡å‹
            â”œâ”€â”€ ds_multitask/             # å¤šä»»åŠ¡æ¨¡å‹
            â”œâ”€â”€ qwen_single/              # åŸºäº Qwen çš„å•ä»»åŠ¡æ¨¡å‹
            â””â”€â”€ qwen_multitask/           # åŸºäº Qwen çš„å¤šä»»åŠ¡æ¨¡å‹
```

### modules/retriever/ - æ£€ç´¢æ¨¡å—

```
modules/retriever/
â”œâ”€â”€ rag_retriever.py          # RAG æ£€ç´¢æ ¸å¿ƒå®ç°
â”‚                             # - DenseEncoder: ç¨ å¯†å‘é‡ç¼–ç ï¼ˆSentenceTransformerï¼‰
â”‚                             # - KnowledgeSearcher: æ··åˆæ£€ç´¢ï¼ˆFAISS + BM25 + é‡æ’åºï¼‰
â”‚                             # - KBIngestor: çŸ¥è¯†åº“å…¥åº“å·¥å…·
â”‚
â””â”€â”€ ingest_kb.py              # çŸ¥è¯†åº“å…¥åº“è„šæœ¬ï¼ˆCLI å·¥å…·ï¼‰
                              # ç”¨æ³•: python ingest_kb.py --ingest <çŸ¥è¯†åº“è·¯å¾„> --kb_name <åº“å>
```

---

## ğŸ“š data/ - æ•°æ®ç›®å½•

### data/knowledge/ - çŸ¥è¯†åº“åŸå§‹æ–‡ä»¶

```
data/knowledge/
â”œâ”€â”€ ev/           # ç”µåŠ¨æ±½è½¦çŸ¥è¯†åº“
â”œâ”€â”€ handbook/     # æ“ä½œæ‰‹å†ŒçŸ¥è¯†åº“
â”œâ”€â”€ health/       # å¥åº·çŸ¥è¯†åº“
â”œâ”€â”€ iov/          # è½¦è”ç½‘çŸ¥è¯†åº“
â”œâ”€â”€ law/          # æ³•å¾‹æ³•è§„çŸ¥è¯†åº“
â”œâ”€â”€ parking/      # åœè½¦çŸ¥è¯†åº“
â”œâ”€â”€ report/       # æŠ¥å‘ŠçŸ¥è¯†åº“
â””â”€â”€ transit/      # äº¤é€šçŸ¥è¯†åº“
```

### data/models/ - é¢„è®­ç»ƒæ¨¡å‹æ‰“åŒ…

```
data/models/
â”œâ”€â”€ bert-base-chinese/        # ä¸­æ–‡ BERT åŸºç¡€æ¨¡å‹ï¼ˆHuggingFaceï¼‰
â””â”€â”€ ds_single/                # loraå¾®è°ƒåçš„åŒ»ç–—æ„å›¾æ¨¡å‹ï¼ˆæ•°æ®é›†ä½¿ç”¨dså¢å¼ºè¿‡çš„huatuoæ•°æ®ï¼‰
```

### data/storage/ - æ£€ç´¢ç´¢å¼•å­˜å‚¨

æ¯ä¸ªçŸ¥è¯†åº“å¯¹åº”ä¸€ä¸ªå­ç›®å½•ï¼ŒåŒ…å«ï¼š

```
data/storage/
â”œâ”€â”€ <kb_name>/                # çŸ¥è¯†åº“åç§°ï¼ˆå¦‚ ev, health, law ç­‰ï¼‰
â”‚   â”œâ”€â”€ index.faiss          # FAISS å‘é‡ç´¢å¼•æ–‡ä»¶
â”‚   â”œâ”€â”€ meta.jsonl           # æ–‡æ¡£å…ƒæ•°æ®ï¼ˆæ–‡æœ¬ã€æ¥æºç­‰ï¼‰
â”‚   â””â”€â”€ bm25_tokens.json     # BM25 åˆ†è¯ç´¢å¼•
```

**æ³¨æ„**ï¼šè¿™äº›ç´¢å¼•æ–‡ä»¶ç”± `modules/retriever/ingest_kb.py` ç”Ÿæˆ

---

## ğŸš€ scripts/ - è„šæœ¬ç›®å½•

```
scripts/
â””â”€â”€ cli.py                    # å‘½ä»¤è¡Œäº¤äº’å·¥å…·ï¼ˆLangChain ç‰ˆæœ¬ï¼‰
                              # ç”¨æ³•: python scripts/cli.py
                              # æä¾›äº¤äº’å¼é—®ç­”ç•Œé¢
```

---

## ğŸ“‹ æ¶æ„è¯´æ˜

### åˆ†å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  scripts/cli.py                     â”‚  åº”ç”¨å±‚
â”‚  (CLI äº¤äº’)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lc/                                 â”‚  LangChain é€‚é…å±‚
â”‚  - rag_chain.py                      â”‚  - ä½¿ç”¨ LCEL ç¼–æ’æµç¨‹
â”‚  - intent_adapter.py                 â”‚  - é€‚é… LangChain æ¥å£
â”‚  - retriever_adapter.py              â”‚
â”‚  - llm_adapter.py                    â”‚
â”‚  - prompt_adapter.py                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  modules/                            â”‚  åº•å±‚å®ç°å±‚
â”‚  - generator/prompt.py               â”‚  - ä¸šåŠ¡é€»è¾‘å®ç°
â”‚  - intent/intent_classify.py         â”‚  - ä¸ä¾èµ–ç‰¹å®šæ¡†æ¶
â”‚  - retriever/rag_retriever.py        â”‚  - å¯ç‹¬ç«‹ä½¿ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  data/                               â”‚  æ•°æ®å±‚
â”‚  - knowledge/                        â”‚  - åŸå§‹çŸ¥è¯†åº“
â”‚  - models/                           â”‚  - é¢„è®­ç»ƒæ¨¡å‹
â”‚  - storage/                          â”‚  - æ£€ç´¢ç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·é—®é¢˜
  â†“
lc/rag_chain.py (LCEL é“¾)
  â†“
lc/intent_adapter.py (æ„å›¾è¯†åˆ«)
  â†“ æ„å›¾ â†’ çŸ¥è¯†åº“è·¯ç”±
lc/retriever_adapter.py (æ–‡æ¡£æ£€ç´¢)
  â†“ æ£€ç´¢ç»“æœ
lc/prompt_adapter.py (æ„å»º Prompt)
  â†“
lc/llm_adapter.py (LLM ç”Ÿæˆ)
  â†“
ç­”æ¡ˆè¿”å›
```

---

## ğŸ”‘ å…³é”®é…ç½®æ–‡ä»¶

- **settings.py**: å…¨å±€é…ç½®ï¼ˆæ¨¡å‹è·¯å¾„ã€API å¯†é’¥ã€æ£€ç´¢å‚æ•°ï¼‰
- **requirements.txt**: Python ä¾èµ–åŒ…
- **.env**: ç¯å¢ƒå˜é‡ï¼ˆé€šå¸¸ä¸æäº¤åˆ° Gitï¼Œéœ€è¦å•ç‹¬é…ç½®ï¼‰

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. åˆå§‹åŒ–ç¯å¢ƒ

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env  # å¦‚æœæœ‰ç¤ºä¾‹æ–‡ä»¶
# ç¼–è¾‘ .env å¡«å…¥ API keys ç­‰é…ç½®
```

### 2. å‡†å¤‡çŸ¥è¯†åº“

```bash
# å…¥åº“çŸ¥è¯†åº“ï¼ˆç¤ºä¾‹ï¼‰
python modules/retriever/ingest_kb.py --ingest data/knowledge/health --kb_name health
```

### 3. è¿è¡Œåº”ç”¨

```bash
# å‘½ä»¤è¡Œäº¤äº’
python scripts/cli.py
```

---

## ğŸ—‚ï¸ æ–‡ä»¶å‘½åçº¦å®š

- **é€‚é…å™¨**: `*_adapter.py` - LangChain é€‚é…å±‚æ–‡ä»¶
- **æ ¸å¿ƒå®ç°**: `*.py` - åº•å±‚å®ç°æ–‡ä»¶
- **æ•°æ®ç±»å‹**: `rag_types.py` - é€šç”¨æ•°æ®ç±»å‹å®šä¹‰
- **é…ç½®**: `settings.py` - å…¨å±€é…ç½®

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **æ¨¡å‹æ–‡ä»¶**: `data/models/` å’Œ `modules/intent/model_training/models/` ä¸­çš„æ¨¡å‹æ–‡ä»¶é€šå¸¸è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨ Git LFS æˆ–å•ç‹¬ä¸‹è½½
2. **ç´¢å¼•æ–‡ä»¶**: `data/storage/` ä¸­çš„ç´¢å¼•æ–‡ä»¶ç”±å…¥åº“è„šæœ¬è‡ªåŠ¨ç”Ÿæˆï¼Œé¦–æ¬¡ä½¿ç”¨éœ€è¦å…ˆè¿è¡Œå…¥åº“
3. **ç¯å¢ƒå˜é‡**: `.env` æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
4. **ä¾èµ–ç‰ˆæœ¬**: å»ºè®®ä¸¥æ ¼æŒ‰ç…§ `requirements.txt` ä¸­çš„ç‰ˆæœ¬å®‰è£…ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
