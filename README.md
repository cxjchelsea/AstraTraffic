# 🚦 AstraTraffic - 个人出行管家

> 你的智能出行助手：从知识问答到出行规划，用 AI 重新定义个人交通出行体验

**AstraTraffic** 是一个面向个人用户的智能出行管家系统，旨在通过大语言模型和智能体技术，为用户提供全方位的出行服务支持。系统从知识问答起步，逐步发展为能够理解用户需求、规划出行路线、提供实时建议的智能助手。

---

## 🎯 项目愿景

**AstraTraffic** 致力于成为你的专属出行管家，最终实现：

### 🌟 核心愿景
- 🧠 **智能理解**：理解用户的出行意图和需求，无论是查询交通法规还是规划出行路线
- 📚 **知识问答**：提供准确的交通相关知识点（法规、停车、公交、电动汽车等）
- 🗺️ **出行规划**：基于用户偏好、实时路况和历史数据，提供个性化出行建议
- ⏰ **实时感知**：整合实时交通数据、天气信息，为用户提供及时的建议和提醒
- 🤖 **主动服务**：不只是在被询问时回答，还能主动提醒、建议和规划

### 🚧 当前阶段：知识问答系统

目前已完成的核心能力：

- 📚 **多知识库智能问答**：支持交通法规、停车、公交、电动汽车等多个垂直领域的知识库
- 🧠 **智能意图路由**：自动识别用户意图，精准路由到对应的知识库
- 🔍 **高质量检索**：融合稠密向量检索（FAISS）和稀疏检索（BM25），提升检索精度
- 💬 **自然语言交互**：用户可通过自然语言提问，系统自动检索相关知识并生成回答
- 🔧 **灵活的架构设计**：基于 LangChain 构建，支持多种 LLM（OpenAI、Ollama、自定义 HTTP）

---

## ✨ 已完成功能

### 🏗️ 核心架构

- ✅ **LangChain 架构实现**
  - 使用 LCEL（LangChain Expression Language）构建 RAG 流程
  - 清晰的适配层设计，底层实现与框架解耦
  - 支持意图识别 → 检索 → 生成的全链路编排

- ✅ **意图识别模块**
  - 基于 BERT + LoRA 的意图分类模型
  - 支持规则匹配和模型预测两种方式
  - 可路由到不同知识库（交通法规、停车、公交、电动汽车等）

### 🔍 检索系统

- ✅ **混合检索**
  - 稠密检索：基于 SentenceTransformer 的向量检索（FAISS）
  - 稀疏检索：基于 BM25 的关键词匹配
  - 重排序：可选的跨编码器重排序提升结果质量

- ✅ **多知识库支持**
  - 支持多个垂直领域的知识库
  - 每个知识库独立的索引存储
  - 知识库入库工具（`ingest_kb.py`）

### 🤖 LLM 集成

- ✅ **多 LLM 适配**
  - OpenAI API（GPT 系列）
  - Ollama（本地大模型）
  - 自定义 HTTP LLM 接口

- ✅ **Prompt 工程**
  - 领域特定的提示词模板
  - 检索结果格式化
  - 引用溯源支持

### 🛠️ 工具与脚本

- ✅ **命令行交互工具**（`scripts/cli.py`）
  - 交互式问答界面
  - 实时显示意图识别结果和检索证据

- ✅ **知识库管理**
  - 知识库入库工具
  - 支持多种文本格式（`.txt`, `.md` 等）

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────┐
│       scripts/cli.py                     │  应用层
│       (命令行交互)                        │
└──────────────────┬──────────────────────┘
                    │
┌───────────────────▼──────────────────────┐
│         lc/ (LangChain 适配层)            │
│  ┌────────────────────────────────────┐ │
│  │  rag_chain.py                       │ │  核心编排
│  │  ├─ intent_adapter.py               │ │  意图识别
│  │  ├─ retriever_adapter.py            │ │  文档检索
│  │  ├─ llm_adapter.py                  │ │  LLM 生成
│  │  └─ prompt_adapter.py               │ │  Prompt 构建
│  └────────────────────────────────────┘ │
└───────────────────┬──────────────────────┘
                    │
┌───────────────────▼──────────────────────┐
│      modules/ (底层核心实现)              │
│  ┌────────────────────────────────────┐ │
│  │  intent/intent_classify.py         │ │  BERT + LoRA
│  │  retriever/rag_retriever.py        │ │  FAISS + BM25
│  │  generator/prompt.py                │ │  Prompt 模板
│  └────────────────────────────────────┘ │
└───────────────────┬──────────────────────┘
                    │
┌───────────────────▼──────────────────────┐
│         data/ (数据层)                    │
│  ┌────────────────────────────────────┐ │
│  │  knowledge/  知识库原始文件          │ │
│  │  storage/    FAISS 索引 + BM25      │ │
│  │  models/     预训练模型              │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 🧩 技术栈

### 核心框架
- **LangChain** 0.3.x：RAG 流程编排
- **Python** 3.8+：主要开发语言

### NLP & 检索
- **Transformers** + **PEFT**：BERT + LoRA 意图识别
- **SentenceTransformers**：中文语义向量编码
- **FAISS**：高效向量检索
- **rank-bm25**：关键词匹配检索
- **jieba**：中文分词

### LLM 支持
- **OpenAI**：GPT 系列 API
- **langchain-ollama**：本地 Ollama 模型
- **自定义 HTTP**：支持任意兼容接口

### 数据与工具
- **python-dotenv**：环境变量管理
- **tqdm**：进度条显示

详细依赖请查看 [`requirements.txt`](requirements.txt)

---

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone <your-repo-url>
cd AstraTraffic

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置环境变量

创建 `.env` 文件（参考 `settings.py` 中的配置项）：

```bash
# LLM 配置（至少配置一个）
OPENAI_API_KEY=your_openai_key
# 或
OLLAMA_BASE_URL=http://localhost:11434

# 模型路径（可选，使用默认路径可跳过）
INTENT_MODEL_PATH=data/models/ds_single
EMBEDDING_MODEL=BAAI/bge-small-zh-v1.5
```

### 3. 准备知识库（首次使用）

```bash
# 入库知识库示例
python modules/retriever/ingest_kb.py --ingest data/knowledge/law --kb_name law
python modules/retriever/ingest_kb.py --ingest data/knowledge/parking --kb_name parking
```

### 4. 运行交互式问答

```bash
python scripts/cli.py
```

示例对话：

```
>>> 限行怎么处罚
➡️ 意图：law（0.892） · 路由KB：law
====== 答案 ======
【核心结论】
限行违规处罚依据《道路交通安全法》及相关地方规定...

【建议/步骤】
1. 查看当地限行政策...
2. 如已违规，及时处理...

- 参考：[S1] [S2]
```

---

## 📁 项目结构

```
AstraTraffic/
├── lc/                      # LangChain 适配层
│   ├── rag_chain.py         # RAG 核心链
│   ├── intent_adapter.py    # 意图识别适配
│   ├── retriever_adapter.py # 检索适配
│   ├── llm_adapter.py       # LLM 适配
│   └── prompt_adapter.py    # Prompt 适配
│
├── modules/                 # 底层核心实现
│   ├── intent/              # 意图识别模块
│   ├── retriever/           # 检索模块
│   └── generator/           # 生成器模块
│
├── data/
│   ├── knowledge/           # 知识库原始文件
│   ├── storage/             # FAISS 索引存储
│   └── models/              # 预训练模型
│
├── scripts/
│   └── cli.py               # 命令行交互工具
│
├── rag_types.py             # 数据类型定义
├── settings.py              # 全局配置
└── requirements.txt         # 依赖列表
```

详细结构说明请查看 [`project_structure.md`](project_structure.md)

---

## 🔧 核心功能说明

### 意图识别

系统支持两种意图识别方式：

1. **规则匹配**：基于关键词规则快速匹配
2. **模型预测**：使用 BERT + LoRA 模型进行意图分类

意图 → 知识库映射：
- `law` → 交通法规知识库
- `parking` → 停车知识库
- `transit` → 公共交通知识库
- `ev` → 电动汽车知识库
- ...（可在代码中扩展）

### 混合检索

检索流程：

1. **稠密检索**：使用 SentenceTransformer 将查询编码为向量，在 FAISS 索引中搜索
2. **稀疏检索**：使用 BM25 进行关键词匹配
3. **结果融合**：加权合并两种检索结果
4. **重排序**（可选）：使用跨编码器对结果重新排序
5. **置信度筛选**：仅返回高置信度的检索结果

### 知识库管理

知识库入库会生成：

- `index.faiss`：向量索引文件
- `meta.jsonl`：文档元数据（文本、来源等）
- `bm25_tokens.json`：BM25 分词索引

---

## 📈 发展路线图

### 📍 当前阶段：知识问答系统（已完成 ✅）

- [x] 多知识库智能问答
- [x] 意图识别与路由
- [x] 混合检索系统
- [x] 多 LLM 适配

### 🚀 下一阶段：增强问答与对话

- [ ] **Web 界面**：基于 FastAPI + React 的 Web 问答界面
- [ ] **更多知识库**：扩展交通信号、路况、违章等知识库
- [ ] **检索优化**：引入查询扩展、语义重写等技术
- [ ] **多轮对话**：支持上下文理解的连续对话，记住用户的偏好和历史
- [ ] **评估体系**：构建自动化的问答质量评估系统
- [ ] **知识图谱**：引入知识图谱增强结构化知识

### 🗺️ 未来阶段：出行规划与智能助手

- [ ] **实时路况集成**：接入实时交通数据，提供路况查询和拥堵预测
- [ ] **出行路线规划**：根据起点、终点、偏好（最短/最快/最省）生成最优路线
- [ ] **多模态交通规划**：整合地铁、公交、步行、骑行、驾车等多种出行方式
- [ ] **个性化推荐**：学习用户出行习惯，提供个性化的出行建议
- [ ] **实时提醒服务**：根据实时路况和天气，主动提醒用户调整出行计划
- [ ] **历史记录分析**：分析用户的出行历史，提供出行统计和优化建议

### 🎯 长期愿景：全方位出行管家

- [ ] **出行日历管理**：管理用户的出行计划，自动提醒和优化
- [ ] **成本分析**：计算不同出行方式的成本，帮助用户做出经济决策
- [ ] **环保出行建议**：推荐低碳出行方式，追踪碳排放
- [ ] **紧急情况处理**：在交通突发情况下，快速提供替代方案
- [ ] **语音交互**：支持语音输入和输出，解放双手
- [ ] **多设备同步**：在手机、电脑、智能设备上无缝同步体验

---

## 📝 开发日志

### v0.1 - 知识问答系统（当前版本）

- ✅ 完成 LangChain 架构迁移
- ✅ 实现多知识库路由
- ✅ 集成混合检索系统
- ✅ 支持多种 LLM 后端
- ✅ 完成命令行交互工具
- ✅ 构建交通法规、停车、公交等多个知识库

### 下一版本规划

- [ ] Web 界面开发
- [ ] 多轮对话支持
- [ ] 实时数据接入

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📜 许可证

本项目基于 **MIT License** 开源。

---

## 💡 为什么叫 "AstraTraffic"？

**Astra** 在拉丁语中意为"星星"，象征着指引和导航。**AstraTraffic** 希望成为用户出行路上的"北极星"，提供清晰的方向和贴心的服务。

从知识问答开始，最终成长为全方位的个人出行管家——这是我们正在走的路。🌟

---

**Note**: 这是一个正在积极开发中的项目，欢迎反馈和建议！让我们一起打造更好的出行体验！🚀
