# 🚦 AstraTraffic - 个人出行管家

> 你的智能出行助手：从知识问答到出行规划，用 AI 重新定义个人交通出行体验

**AstraTraffic** 是一个面向个人用户的智能出行管家系统，旨在通过大语言模型和智能体技术，为用户提供全方位的出行服务支持。系统从知识问答起步，逐步发展为能够理解用户需求、规划出行路线、提供实时建议的智能助手。

---

## 🎯 项目愿景

**AstraTraffic** 致力于成为你的专属出行管家，最终实现：

### 🌟 核心愿景
- 🧠 **智能理解**：理解用户的出行意图和需求，无论是查询交通法规还是规划出行路线
- 📚 **知识问答**：提供准确的交通相关知识点（法规、停车、公交、电动汽车等）
- 🗺️ **出行规划**：基于用户偏好、实时路况和历史数据，提供个性化出行建议
- ⏰ **实时感知**：整合实时交通数据、天气信息，为用户提供及时的建议和提醒
- 🤖 **主动服务**：不只是在被询问时回答，还能主动提醒、建议和规划

### 🚧 当前阶段：知识问答系统

目前已完成的核心能力：

- 📚 **知识检索**：混合检索系统（FAISS + BM25），支持多个垂直领域知识库
- 🤖 **LLM 生成**：多 LLM 适配，基于检索结果的智能生成，支持引用溯源
- 🔄 **多轮对话**：对话历史管理，基于上下文的查询改写和理解
- 📡 **实时查询**：实时路况查询，智能道路名称提取，实时工具框架
- 🧠 **智能工具选择**：基于 LLM 提示词的工具选择，自动路由到知识库或实时工具
- 🔧 **灵活架构**：基于 LangChain 的模块化设计，适配器、业务逻辑、核心编排分离

---

## 🛠️ 技术实现

### 📚 知识检索增强（RAG）

- ✅ **混合检索系统**
  - 稠密检索：基于 SentenceTransformer 的向量检索（FAISS）
  - 稀疏检索：基于 BM25 的关键词匹配
  - 重排序：可选的跨编码器重排序提升结果质量
  - 质量检查：基于置信度阈值筛选检索结果

- ✅ **多知识库支持**
  - 支持多个垂直领域的知识库（交通法规、停车、公交、电动汽车、车联网、健康、报告等）
  - 每个知识库独立的索引存储
  - 知识库入库工具（`ingest_kb.py`）
  - 支持多种文本格式（`.txt`, `.md` 等）

### 🤖 LLM 生成

- ✅ **多 LLM 适配**
  - OpenAI API（GPT 系列）
  - Ollama（本地大模型）
  - 自定义 HTTP LLM 接口

- ✅ **智能生成能力**
  - 基于检索结果的上下文生成
  - 领域特定的提示词模板
  - 引用溯源支持（自动添加参考来源）
  - 答案后处理（格式化、引用添加）

### 🏗️ 核心架构

- ✅ **LangChain 架构实现**
  - 使用 LCEL（LangChain Expression Language）构建 RAG 流程
  - 清晰的适配层设计，底层实现与框架解耦
  - 支持工具选择 → 检索 → 生成的全链路编排
  - 模块化设计：适配器、业务逻辑、核心编排分离

### 🛠️ 工具与脚本

- ✅ **Web 前端界面**（`frontend/`）
  - Vue 3 + Vite 构建的现代化 Web 界面
  - 支持实时地图可视化
  - FastAPI 后端 API 服务
  - 适合普通用户使用

- ✅ **命令行调试工具**（`scripts/cli.py`）
  - 开发调试专用：显示详细的调试信息（查询改写、意图识别、历史对话等）
  - 快速测试：无需启动前后端服务，直接测试后端核心逻辑
  - 适合开发者和服务器环境

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────┐
│       scripts/cli.py                   │  应用层
│       (命令行交互)                      │
└──────────────────┬──────────────────────┘
                    │
┌───────────────────▼──────────────────────┐
│         core/ (核心编排)                  │
│  ┌────────────────────────────────────┐ │
│  │  rag_chain.py                       │ │  RAG 流程编排
│  └────────────────────────────────────┘ │
└───────────────────┬──────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
┌───────▼────────┐    ┌─────────▼──────────┐
│  adapters/     │    │  services/          │
│  (适配层)       │    │  (业务逻辑)          │
│  ├─ retriever  │    │  ├─ tool_selector   │
│  ├─ llm        │    │  ├─ quality         │
│  ├─ prompt     │    │  ├─ fallback        │
│  └─ query_     │    │  ├─ realtime_*      │
│     rewriter   │    │  └─ input_handler    │
└───────┬────────┘    └─────────┬──────────┘
        │                       │
        └───────────┬───────────┘
                    │
┌───────────────────▼──────────────────────┐
│      modules/ (底层实现)                  │
│  ┌────────────────────────────────────┐ │
│  │  config/    配置管理                │ │
│  │  types/     类型定义                │ │
│  │  generator/ Prompt & 消息模板       │ │
│  │  chat/      对话历史管理            │ │
│  │  retriever/ FAISS + BM25 检索      │ │
│  │  realtime/  实时API封装             │ │
│  └────────────────────────────────────┘ │
└───────────────────┬──────────────────────┘
                    │
┌───────────────────▼──────────────────────┐
│         data/ (数据层)                    │
│  ┌────────────────────────────────────┐ │
│  │  knowledge/  知识库原始文件          │ │
│  │  storage/    FAISS 索引 + BM25      │ │
│  │  models/     预训练模型              │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 🧩 技术栈

### 核心框架
- **LangChain** 0.3.x：RAG 流程编排
- **Python** 3.8+：主要开发语言

### NLP & 检索
- **Transformers** + **PEFT**：BERT + LoRA 意图识别
- **SentenceTransformers**：中文语义向量编码
- **FAISS**：高效向量检索
- **rank-bm25**：关键词匹配检索
- **jieba**：中文分词

### LLM 支持
- **OpenAI**：GPT 系列 API
- **langchain-ollama**：本地 Ollama 模型
- **自定义 HTTP**：支持任意兼容接口

### 数据与工具
- **python-dotenv**：环境变量管理
- **tqdm**：进度条显示

详细依赖请查看 [`requirements.txt`](requirements.txt)

---

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone <your-repo-url>
cd AstraTraffic

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置环境变量

创建 `.env` 文件（参考 `settings.py` 中的配置项）：

```bash
# LLM 配置（至少配置一个）
OPENAI_API_KEY=your_openai_key
# 或
OLLAMA_BASE_URL=your-url

# 模型路径（可选，使用默认路径可跳过）
INTENT_MODEL_PATH=data/models/ds_single
EMBEDDING_MODEL=BAAI/bge-small-zh-v1.5
```

### 3. 准备知识库（首次使用）

```bash
# 入库知识库示例
python scripts/ingest_kb.py --root data/knowledge --include law,parking
# 或者单独入库
python scripts/ingest_kb.py --root data/knowledge --include law
```

### 4. 启动系统

#### 方式一：Web 界面（推荐，适合普通用户）

```bash
# 启动后端 API
python api/run_server.py

# 启动前端（新终端）
cd frontend
npm install  # 首次运行
npm run dev
```

访问 `http://localhost:3000` 使用 Web 界面。

#### 方式二：命令行工具（开发调试用）

```bash
python scripts/cli.py
```

**注意**：CLI 主要用于开发调试，显示详细的调试信息（查询改写、意图识别等）。普通用户请使用 Web 界面。

### 5. 示例对话

```
>>> 限行怎么处罚
➡️ 工具：kb_law · 路由KB：law
====== 答案 ======
【核心结论】
限行违规处罚依据《道路交通安全法》及相关地方规定...

【建议/步骤】
1. 查看当地限行政策...
2. 如已违规，及时处理...

- 参考：[S1] [S2]
```

---

## 📁 项目结构

```
AstraTraffic/
├── core/                    # 核心编排
│   └── rag_chain.py        # RAG 流程编排（LCEL）
│
├── adapters/               # LangChain 适配器
│   ├── retriever.py        # 检索适配器
│   ├── llm.py              # LLM 适配器
│   ├── prompt.py           # Prompt 适配器
│   └── query_rewriter.py   # 查询改写适配器
│
├── services/               # 业务逻辑
│   ├── tool_selector.py    # 工具选择（LLM决策）
│   ├── quality.py          # 质量检查
│   ├── fallback.py         # 回退逻辑
│   ├── realtime_tool.py    # 实时工具执行
│   ├── realtime_handler.py # 实时数据处理
│   └── input_handler.py    # 输入处理
│
├── modules/                # 底层实现
│   ├── config/             # 配置管理（settings, tool_config）
│   ├── types/             # 类型定义
│   ├── generator/          # Prompt & 消息模板
│   ├── chat/              # 对话历史管理
│   ├── retriever/         # 检索实现（FAISS + BM25）
│   ├── realtime/          # 实时API封装
│   └── (intent已归档至 archive/intent_classification/)
│
├── data/
│   ├── knowledge/          # 知识库原始文件
│   ├── storage/            # FAISS 索引存储
│   └── models/             # 预训练模型
│
├── scripts/
│   └── cli.py              # 命令行交互工具
│
├── lc/                     # 向后兼容层（已废弃）
│   └── __init__.py         # 兼容旧导入路径
│
├── rag_types.py            # 数据类型定义（向后兼容）
├── settings.py             # 全局配置（向后兼容）
└── requirements.txt        # 依赖列表
```

详细结构说明请查看 [`project_structure.md`](project_structure.md)

---

## 🔧 核心功能说明

### 智能工具选择

系统使用 LLM 提示词进行智能工具选择：

1. **工具选择**：基于用户查询，使用 LLM 智能选择最适合的工具
2. **知识库路由**：自动路由到对应的知识库进行检索
3. **实时工具**：支持实时工具（如实时路况查询）

工具 → 知识库映射：
- `kb_law` → 交通法规知识库
- `realtime_traffic` → 实时路况API
- ...（可在 `modules/config/tool_config.py` 中扩展）

### 混合检索

检索流程：

1. **稠密检索**：使用 SentenceTransformer 将查询编码为向量，在 FAISS 索引中搜索
2. **稀疏检索**：使用 BM25 进行关键词匹配
3. **结果融合**：加权合并两种检索结果
4. **重排序**（可选）：使用跨编码器对结果重新排序
5. **置信度筛选**：仅返回高置信度的检索结果

### 知识库管理

知识库入库会生成：

- `index.faiss`：向量索引文件
- `meta.jsonl`：文档元数据（文本、来源等）
- `bm25_tokens.json`：BM25 分词索引

---

## 📈 发展路线图

### ✅ 已完成阶段

#### 第一阶段：知识问答系统
- [x] 多知识库智能问答
- [x] LLM 智能工具选择与路由
- [x] 混合检索系统（FAISS + BM25）
- [x] 多 LLM 适配（OpenAI、Ollama、自定义 HTTP）
- [x] 模块化架构设计

#### 第二阶段：实时数据与可视化
- [x] 实时路况查询（高德地图 API）
- [x] 实时地图可视化（高德地图 JavaScript API）
- [x] Web 前端界面（Vue 3 + FastAPI）
- [x] 前后端数据联动

#### 第三阶段：多轮对话与上下文理解
- [x] 对话历史管理
- [x] 基于上下文的查询改写
- [x] 多用户并发支持

---

### 🚀 下一阶段规划

#### 第四阶段：路径规划与出行预测

**路径规划功能**
- [ ] **多路径方案生成**
  - 基于起点、终点生成多种出行路径
  - 支持驾车、公交、步行、骑行等多种交通方式
  - 路径对比与推荐（时间、距离、费用等）

- [ ] **实时路况优化**
  - 结合实时交通数据，动态调整路径推荐
  - 避开拥堵路段
  - 考虑限行、施工等临时因素

- [ ] **个性化推荐**
  - 基于用户历史偏好（最快、最短、最省等）
  - 学习用户出行习惯
  - 个性化路径排序

**出行预测功能**
- [ ] **出行时间预测**
  - 基于历史数据和实时路况预测出行时间
  - 考虑时段、天气等因素
  - 提供时间范围预测（如：30-40分钟）

- [ ] **拥堵预测**
  - 基于历史拥堵模式预测未来时段路况
  - 结合实时数据动态调整
  - 提供拥堵等级和时间段预测

- [ ] **天气影响分析**
  - 整合天气数据（降雨、雾霾等）
  - 分析天气对出行的影响
  - 提供天气相关的出行建议

- [ ] **主动建议生成**
  - 基于预测结果主动提供出行建议
  - 出行提醒（如：建议提前出发）
  - 替代方案推荐（如：建议改乘地铁）

---

### 🔮 未来展望

- **知识图谱**：引入知识图谱增强结构化知识
- **评估体系**：构建自动化的问答质量评估系统
- **更多知识库**：扩展交通信号、违章、事故处理等知识库
- **检索优化**：引入查询扩展、语义重写等高级技术
- **语音交互**：支持语音输入和语音回复
- **移动端应用**：开发移动端 App，提供更便捷的使用体验

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📜 许可证

本项目基于 **MIT License** 开源。

---

## 💡 为什么叫 "AstraTraffic"？

**Astra** 在拉丁语中意为"星星"，象征着指引和导航。**AstraTraffic** 希望成为用户出行路上的"北极星"，提供清晰的方向和贴心的服务。

从知识问答开始，最终成长为全方位的个人出行管家——这是我们正在走的路。🌟

---

**Note**: 这是一个正在积极开发中的项目，欢迎反馈和建议！让我们一起打造更好的出行体验！🚀
